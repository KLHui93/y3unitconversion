<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•¿åº¦å•ä½æ¢ç®—æŒ‘æˆ˜</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%); /* Vibrant gradient background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* Prevent scrollbar from background effects */
        }
        .app-container {
            position: relative;
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
            padding: 2.5rem; /* p-10 */
            max-width: 750px; /* Wider to accommodate horizontal layout */
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* gap-6 */
            transition: all 0.5s ease-in-out;
        }

        /* Screens */
        .game-screen, .start-screen, .game-over-screen {
            display: none; /* Hidden by default, managed by JS */
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            justify-content: center;
        }
        .start-screen.active, .game-screen.active, .game-over-screen.active {
            display: flex;
        }

        /* Horizontal Question and Input Area */
        .question-interaction-area {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            align-items: center;
            justify-content: center;
            gap: 1rem; /* Space between question and inputs */
            min-height: 4rem; /* Ensure consistent height */
        }

        .question-text {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 600; /* font-semibold */
            color: #374151; /* text-gray-700 */
            line-height: 1.3;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem; /* Increased gap */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            flex-grow: 1; /* Allow input group to take available space */
            min-width: 200px; /* Minimum width for inputs */
        }
        .input-group input {
            padding: 0.75rem 0.5rem; /* Vertical padding, less horizontal */
            border: none; /* No full border */
            border-bottom: 3px solid #6ee7b7; /* Green bottom border as a "line" */
            background-color: transparent; /* Transparent background */
            border-radius: 0; /* No border radius for line effect */
            font-size: 1.5rem; /* Larger text */
            font-weight: 500;
            color: #1f2937;
            width: 90px; /* Specific width for input */
            text-align: center;
            transition: all 0.3s ease-in-out;
        }
        .input-group input:focus {
            outline: none;
            border-color: #059669; /* Darker green on focus */
            box-shadow: 0 2px 0 0 #059669; /* Subtle shadow for depth */
        }
        .input-group span {
            font-size: 1.5rem; /* Unit text size */
            color: #4b5563;
            font-weight: 500;
        }

        .btn {
            padding: 0.85rem 2rem; /* More padding */
            border-radius: 0.75rem; /* rounded-xl */
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* Deeper shadow */
            letter-spacing: 0.05em; /* Slight letter spacing */
            text-transform: uppercase;
        }
        .btn-primary {
            background: linear-gradient(45deg, #3b82f6, #2563eb); /* Blue gradient */
            color: #ffffff; /* text-white */
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #2563eb, #1d4ed8); /* Darker blue gradient */
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #6b7280, #4b5563); /* Gray gradient */
            color: #ffffff; /* text-white */
            border: none;
        }
        .btn-secondary:hover {
            background: linear-gradient(45deg, #4b5563, #374151); /* Darker gray gradient */
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .feedback-message {
            font-size: 1.5rem; /* Larger text */
            font-weight: 700; /* font-bold */
            margin-top: 1rem; /* mt-4 */
            min-height: 2.5rem; /* Prevent layout shift */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feedback-correct {
            color: #10b981; /* text-green-500 */
        }
        .feedback-incorrect {
            color: #ef4444; /* text-red-500 */
        }
        /* Feedback animation */
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-feedback {
            animation: bounceIn 0.5s ease-out;
        }

        .score-display, .progress-display {
            font-size: 1.35rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #374151; /* text-gray-700 */
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 1rem;
        }
        .title {
            font-size: 2.8rem; /* text-5xl */
            font-weight: 800; /* font-extrabold */
            color: #1f2937; /* text-gray-900 */
            margin-bottom: 1rem; /* mb-4 */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .start-screen h2, .game-over-screen h2 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .game-over-screen p {
            font-size: 1.8rem;
            color: #4b5563;
            font-weight: 600;
        }
        .game-over-screen p span {
            color: #059669;
            font-size: 2rem;
        }

        /* Timer Bar */
        .timer-bar-container {
            width: 100%;
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 9999px; /* rounded-full */
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .timer-bar {
            height: 100%;
            background-color: #f59e0b; /* Amber color for timer */
            width: 100%; /* Initial width */
            transition: width linear; /* Smooth transition for width change */
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Start Screen -->
        <div id="start-screen" class="start-screen active">
            <h2 class="title">æ¬¢è¿æ¥åˆ°é•¿åº¦å•ä½æ¢ç®—æŒ‘æˆ˜ï¼</h2>
            <p class="text-xl text-gray-600 mb-6">
                é€šè¿‡ç»ƒä¹ ç±³å’Œå˜ç±³çš„æ¢ç®—ã€åŠ æ³•å’Œå‡æ³•ï¼Œæå‡ä½ çš„æ•°å­¦æŠ€èƒ½ï¼
            </p>
            <button id="start-game-btn" class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="game-screen">
            <h1 class="title">é•¿åº¦å•ä½æ¢ç®—æŒ‘æˆ˜</h1>
            <div class="score-display">
                <span>åˆ†æ•°: <span id="score">0</span></span>
                <span>é—®é¢˜: <span id="questions-attempted">0</span> / <span id="total-questions">10</span></span>
            </div>
            <div class="timer-bar-container">
                <div id="timer-bar" class="timer-bar"></div>
            </div>
            
            <div class="question-interaction-area">
                <p class="question-text" id="question"></p>
                <div class="input-group" id="answer-inputs">
                    <!-- Inputs will be dynamically added here -->
                </div>
            </div>
            
            <div class="flex justify-center gap-6 mt-4">
                <button id="check-btn" class="btn btn-primary">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button id="next-btn" class="btn btn-secondary" style="display: none;">ä¸‹ä¸€é¢˜</button>
            </div>

            <p class="feedback-message" id="feedback"></p>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="game-over-screen">
            <h2 class="title">æ¸¸æˆç»“æŸï¼</h2>
            <p>ä½ çš„æœ€ç»ˆåˆ†æ•°æ˜¯: <span id="final-score">0</span></p>
            <button id="restart-game-btn" class="btn btn-primary">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // Game State
        let score = 0;
        let currentQuestion = {};
        let questionType = 0; // 0: Conversion, 1: Addition, 2: Subtraction
        let questionsAttempted = 0;
        const totalQuestions = 10; // Total questions per game
        const timePerQuestion = 60; // seconds per question (Changed to 60)
        let timeLeft = timePerQuestion;
        let timerInterval;

        // DOM Elements
        const appContainer = document.querySelector('.app-container');
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');

        const scoreDisplay = document.getElementById('score');
        const questionsAttemptedDisplay = document.getElementById('questions-attempted');
        const totalQuestionsDisplay = document.getElementById('total-questions');
        const questionText = document.getElementById('question');
        const answerInputsDiv = document.getElementById('answer-inputs');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedbackMessage = document.getElementById('feedback');
        const finalScoreDisplay = document.getElementById('final-score');
        const timerBar = document.getElementById('timer-bar');

        // Sound Effects (using Tone.js)
        const correctSound = new Tone.MembraneSynth().toDestination();
        const incorrectSound = new Tone.NoiseSynth({
            noise: { type: 'pink' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
        }).toDestination();
        const timerTickSound = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'sine' },
            envelope: { attack: 0.001, decay: 0.05, sustain: 0.01, release: 0.05 }
        }).toDestination();


        /**
         * å°†ç±³è½¬æ¢ä¸ºå˜ç±³
         * @param {number} m - ç±³æ•°
         * @returns {number} å˜ç±³æ•°
         */
        function mToCm(m) {
            return m * 100;
        }

        /**
         * å°†å˜ç±³è½¬æ¢ä¸ºç±³å’Œå‰©ä½™å˜ç±³
         * @param {number} cm - å˜ç±³æ•°
         * @returns {{m: number, cm: number}} åŒ…å«ç±³å’Œå˜ç±³çš„å¯¹è±¡
         */
        function cmToMAndCm(cm) {
            const m = Math.floor(cm / 100);
            const remainingCm = cm % 100;
            return { m, cm: remainingCm };
        }

        /**
         * ç”Ÿæˆä¸€ä¸ªéšæœºæ•´æ•°ï¼ˆåŒ…å«æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼‰
         * @param {number} min - æœ€å°å€¼
         * @param {number} max - æœ€å¤§å€¼
         * @returns {number} éšæœºæ•´æ•°
         */
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * ç”Ÿæˆé•¿åº¦å•ä½æ¢ç®—é—®é¢˜
         */
        function generateConversionQuestion() {
            const type = getRandomInt(0, 1); // 0: m to cm, 1: cm to m & cm

            if (type === 0) { // ç±³åˆ°å˜ç±³
                const meters = getRandomInt(1, 10);
                const correctCm = mToCm(meters);
                questionText.textContent = `${meters}ç±³ = `;
                answerInputsDiv.innerHTML = `
                    <input type="number" id="answer1" placeholder="" class="flex-grow"> <span>å˜ç±³</span>
                `;
                currentQuestion = {
                    type: 'conversion-m-cm',
                    correctAnswer: { cm: correctCm }
                };
            } else { // å˜ç±³åˆ°ç±³å’Œå˜ç±³
                const totalCm = getRandomInt(100, 1000); // 1ç±³åˆ°10ç±³ä¹‹é—´
                const { m, cm } = cmToMAndCm(totalCm);
                questionText.textContent = `${totalCm}å˜ç±³ = `;
                answerInputsDiv.innerHTML = `
                    <input type="number" id="answer1" placeholder="" class="flex-grow"> <span>ç±³</span>
                    <input type="number" id="answer2" placeholder="" class="flex-grow"> <span>å˜ç±³</span>
                `;
                currentQuestion = {
                    type: 'conversion-cm-m-cm',
                    correctAnswer: { m: m, cm: cm }
                };
            }
        }

        /**
         * ç”Ÿæˆé•¿åº¦åŠ æ³•é—®é¢˜
         */
        function generateAdditionQuestion() {
            const numTerms = getRandomInt(2, 3); // 2æˆ–3ä¸ªåŠ æ•°
            let totalM = 0;
            let totalCm = 0;
            let questionParts = [];

            for (let i = 0; i < numTerms; i++) {
                const m = getRandomInt(0, 5);
                const cm = getRandomInt(0, 99);
                totalM += m;
                totalCm += cm;
                questionParts.push(`${m}ç±³${cm}å˜ç±³`);
            }

            const { m: finalM, cm: finalCm } = cmToMAndCm(totalCm);
            totalM += finalM;

            questionText.textContent = questionParts.join(' + ') + ' = ';
            answerInputsDiv.innerHTML = `
                <input type="number" id="answer1" placeholder="" class="flex-grow"> <span>ç±³</span>
                <input type="number" id="answer2" placeholder="" class="flex-grow"> <span>å˜ç±³</span>
            `;
            currentQuestion = {
                type: 'addition',
                correctAnswer: { m: totalM, cm: finalCm }
            };
        }

        /**
         * ç”Ÿæˆé•¿åº¦å‡æ³•é—®é¢˜
         */
        function generateSubtractionQuestion() {
            let m1, cm1, m2, cm2;
            let totalCm1, totalCm2;

            // ç¡®ä¿ç¬¬ä¸€ä¸ªæ•°å¤§äºç¬¬äºŒä¸ªæ•°
            do {
                m1 = getRandomInt(3, 10);
                cm1 = getRandomInt(0, 99);
                m2 = getRandomInt(1, m1); // m2ä¸èƒ½å¤§äºm1
                cm2 = getRandomInt(0, 99);

                totalCm1 = mToCm(m1) + cm1;
                totalCm2 = mToCm(m2) + cm2;
            } while (totalCm1 <= totalCm2); // ç¡®ä¿è¢«å‡æ•°å¤§äºå‡æ•°

            const differenceCm = totalCm1 - totalCm2;
            const { m: finalM, cm: finalCm } = cmToMAndCm(differenceCm);

            questionText.textContent = `${m1}ç±³${cm1}å˜ç±³ - ${m2}ç±³${cm2}å˜ç±³ = `;
            answerInputsDiv.innerHTML = `
                <input type="number" id="answer1" placeholder="" class="flex-grow"> <span>ç±³</span>
                <input type="number" id="answer2" placeholder="" class="flex-grow"> <span>å˜ç±³</span>
            `;
            currentQuestion = {
                type: 'subtraction',
                correctAnswer: { m: finalM, cm: finalCm }
            };
        }

        /**
         * æ£€æŸ¥ç”¨æˆ·ç­”æ¡ˆ
         * @param {boolean} [timedOut=false] - æ˜¯å¦å› ä¸ºè¶…æ—¶è€Œè°ƒç”¨
         */
        function checkAnswer(timedOut = false) {
            stopTimer(); // Stop the timer as soon as answer is checked or timed out

            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('feedback-correct', 'feedback-incorrect', 'animate-feedback');

            let isCorrect = false;
            let userAnswerM, userAnswerCm;

            if (currentQuestion.type === 'conversion-m-cm') {
                userAnswerCm = parseInt(document.getElementById('answer1').value);
                if (!isNaN(userAnswerCm) && userAnswerCm === currentQuestion.correctAnswer.cm) {
                    isCorrect = true;
                }
            } else if (currentQuestion.type === 'conversion-cm-m-cm' || currentQuestion.type === 'addition' || currentQuestion.type === 'subtraction') {
                userAnswerM = parseInt(document.getElementById('answer1').value);
                userAnswerCm = parseInt(document.getElementById('answer2').value);

                if (!isNaN(userAnswerM) && !isNaN(userAnswerCm) &&
                    userAnswerM === currentQuestion.correctAnswer.m &&
                    userAnswerCm === currentQuestion.correctAnswer.cm) {
                    isCorrect = true;
                }
            }

            if (timedOut) {
                feedbackMessage.textContent = `æ—¶é—´åˆ°ï¼`;
                feedbackMessage.classList.add('feedback-incorrect', 'animate-feedback');
                incorrectSound.triggerAttackRelease('8n');
            } else if (isCorrect) {
                feedbackMessage.textContent = 'æ­£ç¡®ï¼ğŸ‰';
                feedbackMessage.classList.add('feedback-correct', 'animate-feedback');
                score += 10; // Add 10 points for correct answer
                correctSound.triggerAttackRelease('C5', '8n');
            } else {
                let correctDisplay = '';
                if (currentQuestion.type === 'conversion-m-cm') {
                    correctDisplay = `${currentQuestion.correctAnswer.cm}å˜ç±³`;
                } else {
                    correctDisplay = `${currentQuestion.correctAnswer.m}ç±³ ${currentQuestion.correctAnswer.cm}å˜ç±³`;
                }
                feedbackMessage.textContent = `é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${correctDisplay}ã€‚`;
                feedbackMessage.classList.add('feedback-incorrect', 'animate-feedback');
                incorrectSound.triggerAttackRelease('8n');
            }

            scoreDisplay.textContent = score;
            checkBtn.style.display = 'none';
            nextBtn.style.display = 'block';
        }

        /**
         * å¼€å§‹è®¡æ—¶å™¨
         */
        function startTimer() {
            timeLeft = timePerQuestion;
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#f59e0b'; // Amber

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / timePerQuestion) * 100;
                timerBar.style.width = `${percentage}%`;

                if (timeLeft <= 5 && timeLeft > 0) { // Flash red when time is low
                    timerBar.style.backgroundColor = '#ef4444'; // Red
                    timerTickSound.triggerAttackRelease('C4', '16n'); // Play a tick sound
                } else if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(true); // Mark as incorrect due to timeout
                }
            }, 1000);
        }

        /**
         * åœæ­¢è®¡æ—¶å™¨
         */
        function stopTimer() {
            clearInterval(timerInterval);
        }

        /**
         * ç”Ÿæˆæ–°çš„é—®é¢˜
         */
        function newQuestion() {
            questionsAttempted++;
            if (questionsAttempted > totalQuestions) {
                gameOver();
                return;
            }

            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('feedback-correct', 'feedback-incorrect', 'animate-feedback');
            checkBtn.style.display = 'block';
            nextBtn.style.display = 'none';
            answerInputsDiv.innerHTML = ''; // Clear previous inputs

            questionsAttemptedDisplay.textContent = questionsAttempted;

            // Randomly select question type
            questionType = getRandomInt(0, 2); // 0: Conversion, 1: Addition, 2: Subtraction

            if (questionType === 0) {
                generateConversionQuestion();
            } else if (questionType === 1) {
                generateAdditionQuestion();
            } else {
                generateSubtractionQuestion();
            }

            // Start timer for the new question
            startTimer();

            // Focus on the first input field if available
            const firstInput = document.getElementById('answer1');
            if (firstInput) {
                firstInput.focus();
            }
        }

        /**
         * å¼€å§‹æ¸¸æˆ
         */
        function startGame() {
            startScreen.classList.remove('active');
            gameScreen.classList.add('active');
            score = 0;
            questionsAttempted = 0;
            scoreDisplay.textContent = score;
            totalQuestionsDisplay.textContent = totalQuestions;
            newQuestion();
        }

        /**
         * æ¸¸æˆç»“æŸ
         */
        function gameOver() {
            stopTimer(); // Ensure timer stops on game over
            gameScreen.classList.remove('active');
            gameOverScreen.classList.add('active');
            finalScoreDisplay.textContent = score;
        }

        /**
         * é‡ç½®æ¸¸æˆ
         */
        function resetGame() {
            gameOverScreen.classList.remove('active');
            startGame();
        }

        // Event Listeners
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        checkBtn.addEventListener('click', () => checkAnswer(false)); // Pass false, not timed out
        nextBtn.addEventListener('click', newQuestion);
        document.getElementById('restart-game-btn').addEventListener('click', resetGame);

        // Initial game setup: Ensure only start screen is active initially
        document.addEventListener('DOMContentLoaded', () => {
            startScreen.classList.add('active');
            gameScreen.classList.remove('active');
            gameOverScreen.classList.remove('active');
        });
    </script>
</body>
</html>
